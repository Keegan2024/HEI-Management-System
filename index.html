<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EID Tracking & Monitoring System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .login-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .main-app {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1, h2, h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 8px;
            color: white;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.completed { background: #48bb78; }
        .stat-card.due { background: #ed8936; }
        .stat-card.overdue { background: #f56565; }
        .stat-card.exception { background: #4a5568; }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .child-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .child-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .child-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .child-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .child-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .info-item {
            display: flex;
            gap: 5px;
        }

        .info-label {
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
        }

        tr:hover {
            background: #f7fafc;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-completed { background: #c6f6d5; color: #22543d; }
        .status-due { background: #feebc8; color: #7c2d12; }
        .status-overdue { background: #fed7d7; color: #742a2a; }
        .status-exception { background: #e2e8f0; color: #1a202c; }
        .status-confirmatory { background: #fef5e7; color: #7c4a03; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-controls select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            min-width: 200px;
        }

        .test-timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            padding: 15px;
            border-left: 3px solid #e2e8f0;
            margin-left: 20px;
            margin-bottom: 15px;
            background: white;
            border-radius: 0 8px 8px 0;
        }

        .timeline-item.completed {
            border-left-color: #48bb78;
        }

        .timeline-item.overdue {
            border-left-color: #f56565;
        }

        .timeline-item.confirmatory {
            border-left-color: #ed8936;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-stage {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .timeline-date {
            font-size: 14px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .monthly-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .month-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .month-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .month-count {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef5e7;
            border-left: 4px solid #ed8936;
            color: #7c4a03;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-box" id="loginBox">
            <h2 style="text-align: center; color: #667eea;">EID Tracking System</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Login to continue</p>
            
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="Enter username">
            </div>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">Login</button>
            
            <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 6px; font-size: 13px;">
                <strong>Demo Credentials:</strong><br>
                Facility: <code>facility1 / pass123</code><br>
                Hub Coordinator: <code>hub1 / pass123</code><br>
                Admin: <code>admin / pass123</code>
            </div>
        </div>

        <!-- Main Application -->
        <div class="main-app" id="mainApp">
            <div class="header">
                <div>
                    <h1>EID Tracking & Monitoring System</h1>
                    <p style="color: #666;">Early Infant Diagnosis Management</p>
                </div>
                <div class="user-info">
                    <div style="text-align: right;">
                        <div id="userRole" style="font-weight: 600; color: #667eea;"></div>
                        <div id="userFacility" style="font-size: 13px; color: #666;"></div>
                    </div>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="showTab('children')">Children Registry</button>
                <button class="tab" onclick="showTab('analysis')">Monthly Analysis</button>
                <button class="tab" onclick="showTab('reports')">Reports</button>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="stats-grid">
                    <div class="stat-card completed" onclick="filterByStatus('completed')">
                        <div class="stat-number" id="statCompleted">0</div>
                        <div class="stat-label">Completed Tests</div>
                    </div>
                    <div class="stat-card due" onclick="filterByStatus('due')">
                        <div class="stat-number" id="statDue">0</div>
                        <div class="stat-label">Due This Month</div>
                    </div>
                    <div class="stat-card overdue" onclick="filterByStatus('overdue')">
                        <div class="stat-number" id="statOverdue">0</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="stat-card exception" onclick="filterByStatus('exception')">
                        <div class="stat-number" id="statException">0</div>
                        <div class="stat-label">Exceptions</div>
                    </div>
                </div>

                <div id="confirmatory-alert"></div>

                <div class="search-box">
                    <input type="text" placeholder="Search by child name, mother name, or ART number..." onkeyup="filterDashboard(this.value)">
                </div>

                <h3>Enrolled Children</h3>
                <div id="childrenCards"></div>
            </div>

            <!-- Children Registry Tab -->
            <div class="tab-content" id="children">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Registered Children</h3>
                    <button class="btn btn-success" onclick="openAddChildModal()">+ Add New Child</button>
                </div>

                <div class="search-box">
                    <input type="text" placeholder="Search by child name, mother name, or ART number..." onkeyup="filterChildren(this.value)">
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Child Name</th>
                            <th>Mother's Name</th>
                            <th>Date of Birth</th>
                            <th>ART Number</th>
                            <th>Phone</th>
                            <th>Facility</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="childrenList">
                    </tbody>
                </table>
            </div>

            <!-- Monthly Analysis Tab -->
            <div class="tab-content" id="analysis">
                <h3>Monthly Due Tests Analysis</h3>
                
                <div class="filter-controls">
                    <select id="analysisYear" onchange="loadMonthlyAnalysis()">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <select id="analysisFacility" onchange="loadMonthlyAnalysis()">
                        <option value="all">All Facilities</option>
                    </select>
                </div>

                <div class="monthly-analysis" id="monthlyAnalysis"></div>

                <h3 style="margin-top: 30px;">Detailed Breakdown</h3>
                <div id="monthlyDetails"></div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-content" id="reports">
                <h3>Reports & Analytics</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="exportToExcel()">Export to Excel</button>
                    <button class="btn btn-secondary" onclick="generateReport()">Generate PDF Report</button>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                    <h4>Summary Statistics</h4>
                    <div id="reportSummary"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Child Modal -->
    <div class="modal" id="addChildModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Register New Child</h3>
                <span class="close" onclick="closeModal('addChildModal')">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Mother's Name *</label>
                <input type="text" id="motherName" required>
            </div>
            
            <div class="form-group">
                <label>Child's Name *</label>
                <input type="text" id="childName" required>
            </div>
            
            <div class="form-group">
                <label>Date of Birth *</label>
                <input type="date" id="dob" required>
            </div>
            
            <div class="form-group">
                <label>Mother's ART Number *</label>
                <input type="text" id="artNumber" required>
            </div>
            
            <div class="form-group">
                <label>Contact Phone</label>
                <input type="tel" id="phone">
            </div>
            
            <div class="form-group" id="facilitySelectGroup" style="display: none;">
                <label>Facility *</label>
                <select id="facilitySelect">
                    <option value="">Select Facility</option>
                </select>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveChild()">Save Child</button>
                <button class="btn btn-secondary" onclick="closeModal('addChildModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Child Details Modal -->
    <div class="modal" id="childDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="childDetailsTitle">Child Test Schedule</h3>
                <span class="close" onclick="closeModal('childDetailsModal')">&times;</span>
            </div>
            
            <div id="childDetailsInfo" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            
            <h4>EID Test Timeline</h4>
            <div class="test-timeline" id="childTestTimeline"></div>
        </div>
    </div>

    <!-- Update Test Modal -->
    <div class="modal" id="updateTestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Test Status</h3>
                <span class="close" onclick="closeModal('updateTestModal')">&times;</span>
            </div>
            
            <input type="hidden" id="testId">
            
            <div class="form-group">
                <label>Test Done Date</label>
                <input type="date" id="doneDate">
            </div>
            
            <div class="form-group">
                <label>Result *</label>
                <select id="testResult" onchange="handleResultChange()">
                    <option value="">Select Result</option>
                    <option value="Negative">Negative</option>
                    <option value="Positive">Positive</option>
                    <option value="Pending">Pending</option>
                    <option value="Not Done">Not Done</option>
                </select>
            </div>

            <div id="positiveAlert" style="display: none;" class="alert alert-warning">
                ⚠️ A confirmatory test will be automatically scheduled for this child due to positive result.
            </div>
            
            <div class="form-group" id="reasonGroup">
                <label>Reason (if not done)</label>
                <select id="testReason">
                    <option value="">Select Reason</option>
                    <option value="Death">Death</option>
                    <option value="Moved">Moved/Transferred</option>
                    <option value="Defaulted">Defaulted</option>
                    <option value="IIT">Interrupted Treatment</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="testRemarks" rows="3"></textarea>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success" onclick="updateTest()">Update Test</button>
                <button class="btn btn-secondary" onclick="closeModal('updateTestModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let currentUser = null;
        let children = [];
        let tests = [];
        
        // Demo users with hub/facility access
        const users = {
            'facility1': { 
                password: 'pass123', 
                role: 'Facility', 
                facility: 'Kanyama Health Center',
                hub: 'Hub 1',
                facilities: ['Kanyama Health Center']
            },
            'hub1': { 
                password: 'pass123', 
                role: 'Hub Coordinator', 
                facility: 'Hub 1 Coordinator',
                hub: 'Hub 1',
                facilities: ['Kanyama Health Center', 'Chilenje Clinic', 'Matero RHC']
            },
            'admin': { 
                password: 'pass123', 
                role: 'Admin', 
                facility: 'Ministry of Health',
                hub: 'All',
                facilities: ['all']
            }
        };

        const facilities = ['Kanyama Health Center', 'Chilenje Clinic', 'Matero RHC', 'UTH', 'Chelston Clinic'];
        const eidStages = ['Birth', '6 Weeks', '6 Months', '9 Months', '12 Months', '18 Months', '24 Months'];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userRole').textContent = currentUser.role;
                document.getElementById('userFacility').textContent = currentUser.facility;
                
                setupFacilityAccess();
                loadDashboard();
                loadChildren();
                loadMonthlyAnalysis();
            } else {
                alert('Invalid credentials');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function setupFacilityAccess() {
            const facilitySelect = document.getElementById('facilitySelect');
            const analysisFacility = document.getElementById('analysisFacility');
            
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            analysisFacility.innerHTML = '<option value="all">All Facilities</option>';
            
            if (currentUser.role === 'Facility') {
                document.getElementById('facilitySelectGroup').style.display = 'none';
            } else {
                document.getElementById('facilitySelectGroup').style.display = 'block';
                const accessibleFacilities = currentUser.facilities[0] === 'all' ? facilities : currentUser.facilities;
                
                accessibleFacilities.forEach(f => {
                    facilitySelect.innerHTML += `<option value="${f}">${f}</option>`;
                    analysisFacility.innerHTML += `<option value="${f}">${f}</option>`;
                });
            }
        }

        function getAccessibleChildren() {
            if (currentUser.facilities[0] === 'all') {
                return children;
            }
            return children.filter(c => currentUser.facilities.includes(c.facility));
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'children') loadChildren();
            if (tabName === 'analysis') loadMonthlyAnalysis();
            if (tabName === 'reports') loadReports();
        }

        function openAddChildModal() {
            document.getElementById('addChildModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function calculateDueDate(dob, stage) {
            const birthDate = new Date(dob);
            let dueDate = new Date(birthDate);
            
            switch(stage) {
                case 'Birth': dueDate.setDate(dueDate.getDate() + 2); break;
                case '6 Weeks': dueDate.setDate(dueDate.getDate() + 42); break;
                case '6 Months': dueDate.setMonth(dueDate.getMonth() + 6); break;
                case '9 Months': dueDate.setMonth(dueDate.getMonth() + 9); break;
                case '12 Months': dueDate.setMonth(dueDate.getMonth() + 12); break;
                case '18 Months': dueDate.setMonth(dueDate.getMonth() + 18); break;
                case '24 Months': dueDate.setMonth(dueDate.getMonth() + 24); break;
            }
            
            return dueDate.toISOString().split('T')[0];
        }

        function saveChild() {
            const selectedFacility = currentUser.role === 'Facility' ? 
                currentUser.facility : 
                document.getElementById('facilitySelect').value;

            if (!selectedFacility) {
                alert('Please select a facility');
                return;
            }

            const child = {
                id: Date.now(),
                motherName: document.getElementById('motherName').value,
                childName: document.getElementById('childName').value,
                dob: document.getElementById('dob').value,
                artNumber: document.getElementById('artNumber').value,
                phone: document.getElementById('phone').value,
                facility: selectedFacility,
                status: 'Active',
                registrationDate: new Date().toISOString().split('T')[0]
            };
            
            children.push(child);
            
            // Generate test schedule
            eidStages.forEach(stage => {
                tests.push({
                    id: Date.now() + Math.random(),
                    childId: child.id,
                    childName: child.childName,
                    stage: stage,
                    dueDate: calculateDueDate(child.dob, stage),
                    doneDate: null,
                    result: null,
                    reason: null,
                    remarks: null,
                    status: 'Pending',
                    isConfirmatory: false
                });
            });
            
            closeModal('addChildModal');
            loadChildren();
            loadDashboard();
            alert('Child registered successfully!');
            
            // Clear form
            document.getElementById('motherName').value = '';
            document.getElementById('childName').value = '';
            document.getElementById('dob').value = '';
            document.getElementById('artNumber').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('facilitySelect').value = '';
        }

        function loadChildren() {
            const tbody = document.getElementById('childrenList');
            tbody.innerHTML = '';
            
            const accessibleChildren = getAccessibleChildren();
            
            accessibleChildren.forEach(child => {
                tbody.innerHTML += `
                    <tr>
                        <td>${child.childName}</td>
                        <td>${child.motherName}</td>
                        <td>${child.dob}</td>
                        <td>${child.artNumber}</td>
                        <td>${child.phone || '-'}</td>
                        <td>${child.facility}</td>
                        <td><span class="status-badge status-completed">${child.status}</span></td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="viewChildDetails(${child.id})">View Details</button>
                        </td>
                    </tr>
                `;
            });
        }

        function getTestStatus(test) {
            if (test.result && test.doneDate) return 'Completed';
            if (test.reason) return 'Exception';
            
            const today = new Date();
            const due = new Date(test.dueDate);
            
            if (due < today) return 'Overdue';
            
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const dueMonth = due.getMonth();
            const dueYear = due.getFullYear();
            
            if (dueYear === currentYear && dueMonth === currentMonth) return 'Due';
            return 'Pending';
        }

        function loadDashboard() {
            const accessibleChildren = getAccessibleChildren();
            const accessibleTests = tests.filter(t => {
                const child = children.find(c => c.id === t.childId);
                return child && accessibleChildren.includes(child);
            });

            let completed = 0, due = 0, overdue = 0, exception = 0;
            let confirmatory = 0;
            
            accessibleTests.forEach(test => {
                const status = getTestStatus(test);
                if (status === 'Completed') completed++;
                else if (status === 'Due') due++;
                else if (status === 'Overdue') overdue++;
                else if (status === 'Exception') exception++;

                if (test.isConfirmatory && !test.result) confirmatory++;
            });
            
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statDue').textContent = due;
            document.getElementById('statOverdue').textContent = overdue;
            document.getElementById('statException').textContent = exception;

            // Show confirmatory alert
            const alertDiv = document.getElementById('confirmatory-alert');
            if (confirmatory > 0) {
                alertDiv.innerHTML = `
                    <div class="alert alert-warning">
                        ⚠️ <strong>${confirmatory} confirmatory test${confirmatory > 1 ? 's' : ''}</strong> pending for children with positive results. Please follow up.
                    </div>
                `;
            } else {
                alertDiv.innerHTML = '';
            }
            
            // Load children cards
            const cardsDiv = document.getElementById('childrenCards');
            cardsDiv.innerHTML = '';
            
            accessibleChildren.forEach(child => {
                const childTests = tests.filter(t => t.childId === child.id);
                const dueTests = childTests.filter(t => {
                    const status = getTestStatus(t);
                    return status === 'Due' || status === 'Overdue';
                }).length;
                const completedTests = childTests.filter(t => t.result && t.doneDate).length;
                const hasConfirmatory = childTests.some(t => t.isConfirmatory && !t.result);

                cardsDiv.innerHTML += `
                    <div class="child-card" onclick="viewChildDetails(${child.id})">
                        <div class="child-card-header">
                            <div class="child-name">${child.childName}</div>
                            ${hasConfirmatory ? '<span class="status-badge status-confirmatory">Confirmatory Pending</span>' : ''}
                        </div>
                        <div class="child-info">
                            <div class="info-item">
                                <span class="info-label">Mother:</span>
                                <span>${child.motherName}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">DOB:</span>
                                <span>${child.dob}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ART:</span>
                                <span>${child.artNumber}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phone:</span>
                                <span>${child.phone || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Facility:</span>
                                <span>${child.facility}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Tests Progress:</span>
                                <span>${completedTests}/${childTests.length} completed</span>
                            </div>
                            ${dueTests > 0 ? `
                            <div class="info-item">
                                <span class="info-label" style="color: #f56565;">Due/Overdue:</span>
                                <span style="color: #f56565; font-weight: 600;">${dueTests} test${dueTests > 1 ? 's' : ''}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            if (accessibleChildren.length === 0) {
                cardsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No children registered yet.</p>';
            }
        }

        function viewChildDetails(childId) {
            const child = children.find(c => c.id === childId);
            const childTests = tests.filter(t => t.childId === childId);
            
            document.getElementById('childDetailsTitle').textContent = `${child.childName} - Test Schedule`;
            
            document.getElementById('childDetailsInfo').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div><strong>Child Name:</strong> ${child.childName}</div>
                    <div><strong>Mother's Name:</strong> ${child.motherName}</div>
                    <div><strong>Date of Birth:</strong> ${child.dob}</div>
                    <div><strong>ART Number:</strong> ${child.artNumber}</div>
                    <div><strong>Phone:</strong> ${child.phone || 'N/A'}</div>
                    <div><strong>Facility:</strong> ${child.facility}</div>
                </div>
            `;
            
            const timeline = document.getElementById('childTestTimeline');
            timeline.innerHTML = '';
            
            childTests.forEach(test => {
                const status = getTestStatus(test);
                let statusClass = '';
                if (status === 'Completed') statusClass = 'completed';
                else if (status === 'Overdue') statusClass = 'overdue';
                else if (test.isConfirmatory) statusClass = 'confirmatory';
                
                timeline.innerHTML += `
                    <div class="timeline-item ${statusClass}">
                        <div class="timeline-content">
                            <div class="timeline-stage">
                                ${test.stage}${test.isConfirmatory ? ' (Confirmatory)' : ''}
                            </div>
                            <div class="timeline-date">
                                <strong>Due Date:</strong> ${test.dueDate}
                                ${test.doneDate ? `<br><strong>Done Date:</strong> ${test.doneDate}` : ''}
                            </div>
                            <div style="margin-top: 8px;">
                                <span class="status-badge status-${status.toLowerCase()}">${status}</span>
                                ${test.result ? `<span class="status-badge" style="margin-left: 5px; background: #e6f7ff; color: #0066cc;">${test.result}</span>` : ''}
                            </div>
                            ${test.remarks ? `<div style="margin-top: 8px; font-size: 13px; color: #666;"><em>${test.remarks}</em></div>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-primary" style="padding: 5px 15px; font-size: 12px;" onclick="openUpdateTestModal(${test.id})">Update</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('childDetailsModal').style.display = 'block';
        }

        function openUpdateTestModal(testId) {
            const test = tests.find(t => t.id === testId);
            document.getElementById('testId').value = testId;
            document.getElementById('doneDate').value = test.doneDate || '';
            document.getElementById('testResult').value = test.result || '';
            document.getElementById('testReason').value = test.reason || '';
            document.getElementById('testRemarks').value = test.remarks || '';
            document.getElementById('positiveAlert').style.display = 'none';
            
            closeModal('childDetailsModal');
            document.getElementById('updateTestModal').style.display = 'block';
        }

        function handleResultChange() {
            const result = document.getElementById('testResult').value;
            const reasonGroup = document.getElementById('reasonGroup');
            const positiveAlert = document.getElementById('positiveAlert');
            
            if (result === 'Positive') {
                positiveAlert.style.display = 'block';
                reasonGroup.style.display = 'none';
            } else if (result === 'Not Done') {
                reasonGroup.style.display = 'block';
                positiveAlert.style.display = 'none';
            } else {
                reasonGroup.style.display = 'none';
                positiveAlert.style.display = 'none';
            }
        }

        function updateTest() {
            const testId = parseFloat(document.getElementById('testId').value);
            const test = tests.find(t => t.id === testId);
            
            const result = document.getElementById('testResult').value;
            test.doneDate = document.getElementById('doneDate').value;
            test.result = result;
            test.reason = document.getElementById('testReason').value;
            test.remarks = document.getElementById('testRemarks').value;
            
            // If positive result, create confirmatory test
            if (result === 'Positive' && !test.isConfirmatory) {
                const child = children.find(c => c.id === test.childId);
                const doneDate = new Date(test.doneDate);
                const confirmDate = new Date(doneDate);
                confirmDate.setDate(confirmDate.getDate() + 14); // 2 weeks later
                
                tests.push({
                    id: Date.now() + Math.random(),
                    childId: test.childId,
                    childName: test.childName,
                    stage: test.stage + ' - Confirmatory',
                    dueDate: confirmDate.toISOString().split('T')[0],
                    doneDate: null,
                    result: null,
                    reason: null,
                    remarks: 'Confirmatory test for positive result',
                    status: 'Pending',
                    isConfirmatory: true
                });
                
                alert('Test updated! A confirmatory test has been scheduled in 2 weeks.');
            }
            
            closeModal('updateTestModal');
            loadDashboard();
            alert('Test updated successfully!');
        }

        function loadMonthlyAnalysis() {
            const year = parseInt(document.getElementById('analysisYear').value);
            const selectedFacility = document.getElementById('analysisFacility').value;
            
            const accessibleChildren = getAccessibleChildren();
            const filteredChildren = selectedFacility === 'all' ? 
                accessibleChildren : 
                accessibleChildren.filter(c => c.facility === selectedFacility);
            
            const monthlyDiv = document.getElementById('monthlyAnalysis');
            monthlyDiv.innerHTML = '';
            
            const monthlyData = [];
            
            for (let month = 0; month < 12; month++) {
                const dueCount = tests.filter(t => {
                    const child = filteredChildren.find(c => c.id === t.childId);
                    if (!child) return false;
                    
                    const dueDate = new Date(t.dueDate);
                    return dueDate.getFullYear() === year && dueDate.getMonth() === month;
                }).length;
                
                monthlyData.push({ month, count: dueCount });
                
                monthlyDiv.innerHTML += `
                    <div class="month-card" onclick="showMonthDetails(${month}, ${year})">
                        <div class="month-name">${months[month]}</div>
                        <div class="month-count">${dueCount}</div>
                        <div style="font-size: 12px; color: #666;">tests due</div>
                    </div>
                `;
            }
        }

        function showMonthDetails(month, year) {
            const selectedFacility = document.getElementById('analysisFacility').value;
            const accessibleChildren = getAccessibleChildren();
            const filteredChildren = selectedFacility === 'all' ? 
                accessibleChildren : 
                accessibleChildren.filter(c => c.facility === selectedFacility);
            
            const monthTests = tests.filter(t => {
                const child = filteredChildren.find(c => c.id === t.childId);
                if (!child) return false;
                
                const dueDate = new Date(t.dueDate);
                return dueDate.getFullYear() === year && dueDate.getMonth() === month;
            });
            
            const detailsDiv = document.getElementById('monthlyDetails');
            detailsDiv.innerHTML = `
                <h4>${months[month]} ${year} - ${monthTests.length} Tests Due</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Child Name</th>
                            <th>Stage</th>
                            <th>Due Date</th>
                            <th>Facility</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            monthTests.forEach(test => {
                const child = children.find(c => c.id === test.childId);
                const status = getTestStatus(test);
                detailsDiv.innerHTML += `
                    <tr>
                        <td>${test.childName}</td>
                        <td>${test.stage}</td>
                        <td>${test.dueDate}</td>
                        <td>${child ? child.facility : '-'}</td>
                        <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="viewChildDetails(${test.childId})">View</button>
                        </td>
                    </tr>
                `;
            });
            
            detailsDiv.innerHTML += '</tbody></table>';
        }

        function filterDashboard(query) {
            const cards = document.querySelectorAll('.child-card');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function filterChildren(query) {
            const rows = document.querySelectorAll('#childrenList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function filterByStatus(status) {
            // Future enhancement: filter dashboard by status
            alert(`Filtering by ${status} status`);
        }

        function loadReports() {
            const accessibleChildren = getAccessibleChildren();
            const accessibleTests = tests.filter(t => {
                const child = children.find(c => c.id === t.childId);
                return child && accessibleChildren.includes(child);
            });

            const summary = document.getElementById('reportSummary');
            const completedTests = accessibleTests.filter(t => t.result && t.doneDate).length;
            const overdueTests = accessibleTests.filter(t => getTestStatus(t) === 'Overdue').length;
            const confirmatoryTests = accessibleTests.filter(t => t.isConfirmatory).length;
            const positiveResults = accessibleTests.filter(t => t.result === 'Positive').length;

            summary.innerHTML = `
                <p><strong>Total Children Registered:</strong> ${accessibleChildren.length}</p>
                <p><strong>Total Tests Scheduled:</strong> ${accessibleTests.length}</p>
                <p><strong>Tests Completed:</strong> ${completedTests}</p>
                <p><strong>Tests Overdue:</strong> ${overdueTests}</p>
                <p><strong>Active Exceptions:</strong> ${accessibleTests.filter(t => t.reason).length}</p>
                <p><strong>Positive Results:</strong> ${positiveResults}</p>
                <p><strong>Confirmatory Tests:</strong> ${confirmatoryTests}</p>
                <p><strong>Facilities Covered:</strong> ${currentUser.facilities[0] === 'all' ? facilities.length : currentUser.facilities.length}</p>
            `;
        }

        function exportToExcel() {
            alert('Excel export functionality - would download comprehensive data for all accessible facilities');
        }

        function generateReport() {
            alert('PDF report generation - would create detailed report with charts and analysis');
        }
    </script>
</body>
</html>